<style lang='css'>
@import "../assets/style/animate.wxss";

.recorder {
  width: 80%;
  position: absolute;
  bottom: 0;
  padding: 15px calc(10%) 2rem;
}
</style>
<template>
<view class="container">

    <bulletin></bulletin>
    <view>{{log}}</view>
    <view id="btn-speak" class="recorder {{animation}}">
      <button type="{{buttonState.type}}"
          @tap="tip" @longpress="record" @touchend="touchend" @touchcancel=""
          hover-stop-propagation="true">
        {{buttonState.content}}
      </button>
    </view>

</view>
</template>


<script>
import wepy from "wepy";
import Bulletin from "@/components/bulletin";
import Mock from "@/util/Mock";
const pageVars = {
  readyToRecord: "准备说：",
  buttonTip: "请长按录音...",
  recording: "正在录音...",
  canceled: "已取消!",
  waitAWhile: "请稍后...",
  cancelRecording: "向上滑动松开 取消录音"
};

const status = {
  beforeRecording: 0,
  recording: 1,
  recorded: 2,
  canceled: 3
};
export default class BeforeSpeak extends wepy.page {
  config = {
    navigationBarTitleText: "准备说"
  };
  components = {
    bulletin: Bulletin
  };

  mixins = [];

  data = {
    animation: "animated bounce", //record button div
    buttonState: {
      content: pageVars.readyToRecord,
      type: "default"
    },
    currentStatus: status.beforeRecording,
    touchPoint: {
      clientX: 0,
      clientY: 0
    },
    recorderManager: null, //recorderManager
    tempFilePath: "", //save
    log: ""
  };

  computed = {
    now() {
      return +new Date();
    }
  };

  methods = {
    tip() {
      this.buttonState.content = pageVars.buttonTip;
    },
    record(e) {
      //longpress
      //change status

      //vibrate and alert sound
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          wepy.vibrateShort();
        }, i * 15);
      }

      this.currentStatus = status.recording;
      this.buttonState.content = pageVars.cancelRecording;
      wepy.showToast({
        icon: "loading",
        title: pageVars.recording,
        mask: true,
        duration: 60000
      });
      //mark the coordinates
      this.touchPoint = {
        clientX: e.touches[0].clientX,
        clientY: e.touches[0].clientY
      };

      //start recording------
      let args = {
        duration: 60000,
        sampleRate: 16000,
        numberOfChannels: 1,
        encodeBitRate: 36000,
        format: "aac"
      };
      this.recorderManager.start(args);
    },
    touchend(e) {
      //when catch the touchend event , we should check the status first
      if (status.recording === this.currentStatus) {
        wepy.hideToast();
        let slidedUp =  (this.touchPoint.clientY - e.changedTouches[0].clientY) > 20; // canceling recording by sliding up
        if (slidedUp) {
          // if canceled the recording
          console.log("canceled the recording");
          this.currentStatus = status.canceled;
          this.buttonState.content = pageVars.readyToRecord; //reset the button
          setTimeout(() => {
            wepy.showToast({
              title: pageVars.canceled,
              icon: "none"
            });
          }, 300);
          //stop recording and not save
          this.recorderManager.stop();
        } else {
          //console.log('recorded')
          // 录音完成 处理文件时锁定屏幕
          wepy.showLoading({
            title: pageVars.waitAWhile,
            mask: true
          });
          // 处理录音文件
          console.log('stop recording')
          this.recorderManager.stop();
        }
      }
    }
  };

  events = {};

  onLoad() {
    let _this = this
    //检测是否已经打印过bulletin信息，否则直接显示
    wepy.getStorage({
      key: 'BulletinTyped',
      success: function(res) {
        console.log('type info: ' + res.data)
        _this.$invoke("bulletin", "showInfo", Mock.getBulletinInfo());
      },
      fail: function(res) {
        console.log('show info')
        _this.$invoke("bulletin", "typeInfo", Mock.getBulletinInfo());
        wepy.setStorage({
          key:"BulletinTyped",
          data:"true"
        })
      }
    })



    //取得recordmanager
    let rm = wepy.getRecorderManager();
    rm.onStart(() => {
      console.log("recorder start");
    });
    rm.onResume(() => {
      console.log("recorder resume");
    });
    rm.onStop(res => {
      console.log("recorder stop", res);
      //保存临时文件
      this.tempFilePath = res.tempFilePath;
      console.log("filepath: " + this.tempFilePath);
      if (status.canceled === this.currentStatus) {
        this.log = "cancel the recording, nothing saved  ";
      } else {
        // 处理录音文件
        // let ac = wepy.createInnerAudioContext();
        // ac.src = this.tempFilePath;
        // ac.play();
        //this.log = res.tempFilePath
        this.$preload('recordPath', res.tempFilePath)
        this.$redirect({
          url: 'afterspeak'
        })
      }
    });
    this.recorderManager = this.recorderManager || rm;
  }

  onUnload() {

  }
}
</script>
